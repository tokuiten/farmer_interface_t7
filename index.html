<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åç©«ãƒ­ãƒœãƒƒãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f1f8e9;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #81c784;
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .status {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .settings-panel {
            width: 60%;
            background: white;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .map-panel {
            width: 40%;
            padding: 10px 20px 20px 30px;
            overflow: hidden;
            position: relative;
            background: #f1f8e9;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* è¨­å®šãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .robot-controls {
            border: 2px solid #a5d6a7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f1f8e9;
        }
        
        .robot-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: inline-block;
            margin: 5px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 20px;
        }
        
        select, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 20px;
        }
        
        select:disabled {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
        }
        
        button {
            background-color: #66bb6a;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }
        
        button:hover:not(:disabled) {
            background-color: #4caf50;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        #animateBtn {
            background-color: #81c784;
        }
        
        #animateBtn:hover:not(:disabled) {
            background-color: #66bb6a;
        }
        
        #stopBtn {
            background-color: #a5d6a7;
        }
        
        #stopBtn:hover:not(:disabled) {
            background-color: #81c784;
        }
        
        .control-buttons {
            text-align: center;
            margin-top: 20px;
        }

        /* ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .preset-selector {
            background: #a5d6a7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .preset-selector label {
            color: white;
            font-weight: bold;
            font-size: 20px;
            display: block;
            margin-bottom: 10px;
        }

        .preset-selector select {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            background: white;
            min-width: 250px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .accordion-toggle {
            background: #f1f8e9;
            border: 2px solid #81c784;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s;
            user-select: none;
        }

        .accordion-toggle:hover {
            background: #e8f5e8;
        }

        .accordion-toggle.active {
            background: #81c784;
            color: white;
        }

        .accordion-toggle .icon {
            font-size: 20px;
            margin-left: 10px;
            transition: transform 0.3s;
        }

        .accordion-toggle.active .icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .accordion-content.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        /* ç°¡æ˜“ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .quick-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .quick-controls .control-buttons {
            margin-top: 0;
        }

        /* ãƒãƒƒãƒ—ç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        #canvas {
            border: 2px solid #333;
            background-color: white;
            max-width: 100%;
            max-height: 100%;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .settings-panel {
                width: 100%;
                height: 50vh;
            }

            .map-panel {
                width: 100%;
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span>ğŸ¤–</span>
            åç©«ãƒ­ãƒœãƒƒãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        </h1>
        <div class="status">
            <div class="status-item">
                ğŸ“… <span id="current-date"></span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="settings-panel">
            
            <div style="text-align: center; margin-bottom: 15px;">
                <button onclick="showManual()" style="background-color: #81c784; color: white; font-size: 18px; padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: inline-block;">
                    ğŸ“– ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’èª­ã‚€
                </button>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #e8f5e9; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="display: inline-block; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #FF6B6B;"></span>
                            <span style="font-size: 20px;"><strong>ãã¤ã­å·</strong>: å·¦å‘ãåç©«ãƒ­ãƒœãƒƒãƒˆ</span>
                        </div>
                        <div id="robot1Status" style="background: rgba(165, 214, 167, 0.3); padding: 4px 12px; border-radius: 6px; font-size: 20px;">
                            <span id="robot1State">å……é›»ä¸­</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #e8f5e9; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="display: inline-block; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #4A90E2;"></span>
                            <span style="font-size: 20px;"><strong>ãŸã¬ãå·</strong>: å³å‘ãåç©«ãƒ­ãƒœãƒƒãƒˆ</span>
                        </div>
                        <div id="robot2Status" style="background: rgba(165, 214, 167, 0.3); padding: 4px 12px; border-radius: 6px; font-size: 20px;">
                            <span id="robot2State">å¾…æ©Ÿä¸­</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preset-selector">
                <label for="presetSelect" style="font-size: 20px;">ã‚¯ã‚¤ãƒƒã‚¯è¨­å®š</label>
                <div style="display: flex; align-items: center; gap: 15px; justify-content: center; margin-top: 10px;">
                    <select id="presetSelect">
                        <option value="two-robots">2å°ã§å…¨é¢åç©«</option>
                        <option value="left-robot-only">ãã¤ã­å·ã§å…¨é¢åç©«</option>
                        <option value="right-robot-only">ãŸã¬ãå·ã§å…¨é¢åç©«</option>
                        <option value="custom1">ã‚«ã‚¹ã‚¿ãƒ åç©«1</option>
                        <option value="custom2">ã‚«ã‚¹ã‚¿ãƒ åç©«2</option>
                    </select>
                    <button onclick="calculatePaths()" style="background-color: #66bb6a; color: white; font-size: 20px; padding: 10px 20px;">çµŒè·¯ç¢ºèª</button>
                    <button onclick="clearPath()" style="background-color: #66bb6a; color: white; font-size: 20px; padding: 10px 20px;">çµŒè·¯ã‚¯ãƒªã‚¢</button>
                    <button id="playBtn" onclick="startAnimation()" style="background-color: #999; color: white; border: none; font-size: 20px; padding: 10px 15px; margin-left: 10px;" disabled>â–¶</button>
                    <button id="stopBtn" onclick="stopAnimation()" style="background-color: #999; color: white; border: none; font-size: 20px; padding: 10px 15px; margin-left: 5px;" disabled>â¹</button>
                </div>
            </div>
            
            <div class="accordion-toggle" onclick="toggleAccordion()">
                <strong style="font-size: 20px;">è©³ç´°è¨­å®š</strong>
                <span class="icon">â–¼</span>
            </div>
            
            <div class="accordion-content" id="detailSettings">
                <div class="control-buttons" style="margin-bottom: 20px; text-align: center;">
                    <button id="editBtn" onclick="enableEditMode()" style="background-color: #81c784; color: white; font-size: 20px; padding: 10px 20px; margin: 0 5px;">ç·¨é›†</button>
                    <button id="applyBtn" onclick="applySettings()" style="background-color: #66bb6a; color: white; font-size: 20px; padding: 10px 20px; margin: 0 5px;">åæ˜ </button>
                    <button id="clearBtn" onclick="clearToPreset()" style="background-color: #a5d6a7; color: white; font-size: 20px; padding: 10px 20px; margin: 0 5px;">ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="controls">
                <div class="robot-controls">
                    <h3 style="font-size: 20px;"><span style="display: inline-block; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #FF6B6B; margin-right: 8px; vertical-align: middle;"></span>ãã¤ã­å· è¨­å®š</h3>
                    <div class="robot-row">
                        <div class="control-group">
                            <label for="startArea1">é–‹å§‹ã‚¨ãƒªã‚¢:</label>
                            <select id="startArea1" disabled>
                                <option value="1">ã‚¨ãƒªã‚¢1</option>
                                <option value="2">ã‚¨ãƒªã‚¢2</option>
                                <option value="3">ã‚¨ãƒªã‚¢3</option>
                                <option value="4">ã‚¨ãƒªã‚¢4</option>
                                <option value="5">ã‚¨ãƒªã‚¢5</option>
                                <option value="6">ã‚¨ãƒªã‚¢6</option>
                                <option value="7">ã‚¨ãƒªã‚¢7</option>
                                <option value="8">ã‚¨ãƒªã‚¢8</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="startLane1">é–‹å§‹é€šè·¯:</label>
                            <select id="startLane1" disabled>
                                <option value="1">é€šè·¯1</option>
                                <option value="2">é€šè·¯2</option>
                                <option value="3">é€šè·¯3</option>
                                <option value="4">é€šè·¯4</option>
                                <option value="5">é€šè·¯5</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="endArea1">çµ‚äº†ã‚¨ãƒªã‚¢:</label>
                            <select id="endArea1" disabled>
                                <option value="1">ã‚¨ãƒªã‚¢1</option>
                                <option value="2">ã‚¨ãƒªã‚¢2</option>
                                <option value="3">ã‚¨ãƒªã‚¢3</option>
                                <option value="4">ã‚¨ãƒªã‚¢4</option>
                                <option value="5" selected>ã‚¨ãƒªã‚¢5</option>
                                <option value="6">ã‚¨ãƒªã‚¢6</option>
                                <option value="7">ã‚¨ãƒªã‚¢7</option>
                                <option value="8">ã‚¨ãƒªã‚¢8</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="endLane1">çµ‚äº†é€šè·¯:</label>
                            <select id="endLane1" disabled>
                                <option value="1" selected>é€šè·¯1</option>
                                <option value="2">é€šè·¯2</option>
                                <option value="3">é€šè·¯3</option>
                                <option value="4">é€šè·¯4</option>
                                <option value="5">é€šè·¯5</option>
                            </select>
                        </div>
                        
                        
                        <div class="control-group">
                            <label for="harvest1">åç©«é‡(kg):</label>
                            <input type="text" id="harvest1" value="40" disabled 
                                   style="width: 80px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 20px;"
                                   pattern="[0-9]+(\.[0-9]+)?" inputmode="decimal">
                        </div>
                        
                        <div class="control-group">
                            <label for="ripeness1">å®Œç†Ÿåº¦(%):</label>
                            <input type="text" id="ripeness1" value="95" disabled 
                                   style="width: 60px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 20px;"
                                   pattern="[0-9]+(\.[0-9]+)?" inputmode="decimal">
                        </div>
                    </div>
                </div>

                <div class="robot-controls">
                    <h3 style="font-size: 20px;"><span style="display: inline-block; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #4A90E2; margin-right: 8px; vertical-align: middle;"></span>ãŸã¬ãå· è¨­å®š</h3>
                    <div class="robot-row">
                        <div class="control-group">
                            <label for="startArea2">é–‹å§‹ã‚¨ãƒªã‚¢:</label>
                            <select id="startArea2" disabled>
                                <option value="1">ã‚¨ãƒªã‚¢1</option>
                                <option value="2">ã‚¨ãƒªã‚¢2</option>
                                <option value="3">ã‚¨ãƒªã‚¢3</option>
                                <option value="4">ã‚¨ãƒªã‚¢4</option>
                                <option value="5">ã‚¨ãƒªã‚¢5</option>
                                <option value="6">ã‚¨ãƒªã‚¢6</option>
                                <option value="7">ã‚¨ãƒªã‚¢7</option>
                                <option value="8" selected>ã‚¨ãƒªã‚¢8</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="startLane2">é–‹å§‹é€šè·¯:</label>
                            <select id="startLane2" disabled>
                                <option value="1">é€šè·¯1</option>
                                <option value="2">é€šè·¯2</option>
                                <option value="3">é€šè·¯3</option>
                                <option value="4">é€šè·¯4</option>
                                <option value="5" selected>é€šè·¯5</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="endArea2">çµ‚äº†ã‚¨ãƒªã‚¢:</label>
                            <select id="endArea2" disabled>
                                <option value="1">ã‚¨ãƒªã‚¢1</option>
                                <option value="2">ã‚¨ãƒªã‚¢2</option>
                                <option value="3">ã‚¨ãƒªã‚¢3</option>
                                <option value="4" selected>ã‚¨ãƒªã‚¢4</option>
                                <option value="5">ã‚¨ãƒªã‚¢5</option>
                                <option value="6">ã‚¨ãƒªã‚¢6</option>
                                <option value="7">ã‚¨ãƒªã‚¢7</option>
                                <option value="8">ã‚¨ãƒªã‚¢8</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="endLane2">çµ‚äº†é€šè·¯:</label>
                            <select id="endLane2" disabled>
                                <option value="1">é€šè·¯1</option>
                                <option value="2">é€šè·¯2</option>
                                <option value="3">é€šè·¯3</option>
                                <option value="4">é€šè·¯4</option>
                                <option value="5" selected>é€šè·¯5</option>
                            </select>
                        </div>
                        
                        
                        <div class="control-group">
                            <label for="harvest2">åç©«é‡(kg):</label>
                            <input type="text" id="harvest2" value="40" disabled 
                                   style="width: 80px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 20px;"
                                   pattern="[0-9]+(\.[0-9]+)?" inputmode="decimal">
                        </div>
                        
                        <div class="control-group">
                            <label for="ripeness2">å®Œç†Ÿåº¦(%):</label>
                            <input type="text" id="ripeness2" value="95" disabled 
                                   style="width: 60px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 20px;"
                                   pattern="[0-9]+(\.[0-9]+)?" inputmode="decimal">
                        </div>
                    </div>
                </div>


                </div>
            </div>
            
            <div class="quick-controls">
                <div class="control-buttons">
                    <button onclick="sendSettings()" style="background-color: #66bb6a; font-size: 18px; padding: 10px 25px;">å„ãƒ­ãƒœãƒƒãƒˆã«é€ä¿¡</button>
                </div>
            </div>
            
            <div class="accordion-toggle" onclick="toggleLogAccordion()" style="margin-top: 20px;">
                <strong style="font-size: 20px;">éå»ã®åç©«è¨˜éŒ²</strong>
                <span class="icon" id="logIcon">â–¼</span>
            </div>
            
            <div class="accordion-content" id="logContent">
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 16px;">
                        <thead>
                            <tr style="background: #e8f5e9; border-bottom: 2px solid #81c784;">
                                <th style="padding: 10px; text-align: left;">åç©«æ—¥</th>
                                <th style="padding: 10px; text-align: left;">é–‹å§‹æ™‚åˆ»</th>
                                <th style="padding: 10px; text-align: left;">çµ‚äº†æ™‚åˆ»</th>
                                <th style="padding: 10px; text-align: right;">å®Ÿéš›ã®åç©«é‡(kg)</th>
                                <th style="padding: 10px; text-align: center;">è©³ç´°</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody">
                            <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ -->
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 10px;">2024/12/20</td>
                                <td style="padding: 10px;">08:30</td>
                                <td style="padding: 10px;">11:45</td>
                                <td style="padding: 10px; text-align: right;">85.5</td>
                                <td style="padding: 10px; text-align: center;">
                                    <button onclick="showLogDetail(1)" style="background-color: #a5d6a7; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">è©³ç´°</button>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 10px;">2024/12/19</td>
                                <td style="padding: 10px;">09:00</td>
                                <td style="padding: 10px;">12:30</td>
                                <td style="padding: 10px; text-align: right;">92.3</td>
                                <td style="padding: 10px; text-align: center;">
                                    <button onclick="showLogDetail(2)" style="background-color: #a5d6a7; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">è©³ç´°</button>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 10px;">2024/12/18</td>
                                <td style="padding: 10px;">08:00</td>
                                <td style="padding: 10px;">10:45</td>
                                <td style="padding: 10px; text-align: right;">78.8</td>
                                <td style="padding: 10px; text-align: center;">
                                    <button onclick="showLogDetail(3)" style="background-color: #a5d6a7; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">è©³ç´°</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="logDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #4caf50;">åç©«è©³ç´°æƒ…å ±</h3>
                    <div id="logDetailContent"></div>
                </div>
            </div>
            
            <!-- ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="manualModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 85%; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.3);">
                    <h2 style="margin-bottom: 30px; color: #4caf50; text-align: center; border-bottom: 3px solid #4caf50; padding-bottom: 15px;">åç©«ãƒ­ãƒœãƒƒãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h2>
                    
                    <div id="manualContent">
                        <!-- ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å†…å®¹ã¯ manual.html ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
            
            <!-- é€ä¿¡çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="sendResultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1002;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.3);">
                    <h2 style="margin-bottom: 25px; color: #4caf50; text-align: center;">é€ä¿¡çµæœ</h2>
                    
                    <div id="sendResultContent"></div>
                </div>
            </div>
            
        </div>

        <div class="map-panel">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script>
        // ç¾åœ¨ã®æ—¥æ™‚ã‚’è¡¨ç¤º
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
            const timeStr = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('current-date').textContent = `${dateStr} ${timeStr}`;
        }

        updateDateTime();
        setInterval(updateDateTime, 60000); // 1åˆ†ã”ã¨ã«æ›´æ–°
        
        // ãƒ­ãƒœãƒƒãƒˆçŠ¶æ…‹ã®æ›´æ–°
        function updateRobotStatus(robotId, status) {
            const statusElement = document.getElementById(`robot${robotId}State`);
            const statusItem = document.getElementById(`robot${robotId}Status`);
            
            // çŠ¶æ…‹ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            let icon = '';
            switch(status) {
                case 'å……é›»ä¸­':
                    icon = 'ğŸ”‹ ';
                    break;
                case 'å¾…æ©Ÿä¸­':
                    icon = 'â¸ï¸ ';
                    break;
                case 'ç¨¼åƒä¸­':
                    icon = 'ğŸšœ ';
                    break;
                case 'é€šä¿¡ä¸å¯':
                    icon = 'ğŸ“µ ';
                    break;
                default:
                    icon = '';
            }
            
            statusElement.textContent = icon + status;
        }
        
        // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        updateRobotStatus(1, 'å……é›»ä¸­');
        updateRobotStatus(2, 'å¾…æ©Ÿä¸­');
        
        // ãƒ‡ãƒ¢ç”¨: ãƒ­ãƒœãƒƒãƒˆçŠ¶æ…‹ã‚’å®šæœŸçš„ã«æ›´æ–°
        setInterval(function() {
            const states = ['å……é›»ä¸­', 'å¾…æ©Ÿä¸­', 'ç¨¼åƒä¸­', 'é€šä¿¡ä¸å¯'];
            const randomState1 = states[Math.floor(Math.random() * states.length)];
            const randomState2 = states[Math.floor(Math.random() * states.length)];
            // updateRobotStatus(1, randomState1);
            // updateRobotStatus(2, randomState2);
        }, 5000); // 5ç§’ã”ã¨ã«æ›´æ–°ï¼ˆãƒ‡ãƒ¢ç”¨ã€å®Ÿéš›ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰

        // çµŒè·¯ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
        let currentPaths = [];
        
        // ãƒ­ãƒœãƒƒãƒˆè¨­å®šã®åŸºæœ¬é–¢æ•°
        function calculatePaths() {
            console.log('çµŒè·¯è¨ˆç®—ã‚’å®Ÿè¡Œ');
            
            // ç¾åœ¨ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
            const presetSelect = document.getElementById('presetSelect');
            const selectedPreset = presetSelect.value;
            
            // çµŒè·¯ã‚’ã‚¯ãƒªã‚¢
            currentPaths = [];
            
            if (selectedPreset === 'left-robot-only') {
                // ãã¤ã­å·ã§å…¨é¢åç©«ã®çµŒè·¯ã‚’è¨ˆç®—
                calculateKitsunePath();
            } else if (selectedPreset === 'right-robot-only') {
                // ãŸã¬ãå·ã§å…¨é¢åç©«ã®çµŒè·¯ã‚’è¨ˆç®—
                calculateTanukiPath();
            } else if (selectedPreset === 'two-robots') {
                // ï¼’å°ã§å…¨é¢åç©«ã®çµŒè·¯ã‚’è¨ˆç®—
                calculateDualRobotPath();
            }
            // ä»–ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã®çµŒè·¯è¨ˆç®—ã¯å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
            
            // çµŒè·¯ã‚’æç”»
            drawFarm();
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            updateAnimationButtons();
        }

        function clearPath() {
            console.log('çµŒè·¯ã‚’ã‚¯ãƒªã‚¢');
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
            if (isAnimating) {
                stopAnimation();
            }
            // çµŒè·¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            currentPaths = [];
            // ãƒ­ãƒœãƒƒãƒˆã‚’å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã™
            robotPositions.robot1 = { x: leftMargin - 60, y: topBottomMargin + farmHeight / 2 - 15, angle: 0 };
            robotPositions.robot2 = { x: leftMargin - 30, y: topBottomMargin + farmHeight / 2 + 15, angle: 0 };
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å†æç”»
            drawFarm();
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            updateAnimationButtons();
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateAnimationButtons() {
            const hasPath = Array.isArray(currentPaths) ? currentPaths.length > 0 : 
                           (currentPaths.kitsune && currentPaths.tanuki);
            const playBtn = document.getElementById('playBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (hasPath && !isAnimating) {
                playBtn.disabled = false;
                stopBtn.disabled = true;
            } else if (!hasPath) {
                playBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }
        
        // ãã¤ã­å·ã®å…¨é¢åç©«çµŒè·¯ã‚’è¨ˆç®—
        function calculateKitsunePath() {
            // ã‚¨ãƒªã‚¢ã®é †ç•ª: 1,2,3,4,8,7,6,5
            const areaOrder = [1, 2, 3, 4, 8, 7, 6, 5];
            
            currentPaths = [];
            
            // ãã¤ã­å·ã®åˆæœŸä½ç½®ã‚’ã‚¨ãƒªã‚¢1é€šè·¯2ã«è¨­å®š
            const initialLaneX = leftMargin + 0 * areaWidth + (2 - 0.5) * (areaWidth / 5);
            const centralY = topBottomMargin + farmHeight / 2;
            updateRobotPosition(1, initialLaneX, centralY - centralPathWidth/2, 270); // åŒ—å‘ã
            
            areaOrder.forEach(areaNum => {
                const areaIndex = areaNum - 1;
                const row = areaIndex < 4 ? 0 : 1;
                const col = areaIndex % 4;
                
                // åŒ—å´ã‚¨ãƒªã‚¢ï¼ˆ1-4ï¼‰ã¯é€šè·¯2,3,4,5ã€å—å´ã‚¨ãƒªã‚¢ï¼ˆ5-8ï¼‰ã¯é€šè·¯4,3,2,1ã‚’ä½¿ç”¨
                let lanes;
                if (row === 0) {
                    // åŒ—å´: é€šè·¯1ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    lanes = [2, 3, 4, 5];
                } else {
                    // å—å´: é€šè·¯5ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    lanes = [4, 3, 2, 1];
                }
                
                lanes.forEach((laneNum, laneIndex) => {
                    // é€šè·¯ã®ä½ç½®ã‚’è¨ˆç®—
                    const laneWidth = areaWidth / 5;
                    const laneX = leftMargin + col * areaWidth + (laneNum - 0.5) * laneWidth;
                    
                    // é–‹å§‹ç‚¹ï¼ˆä¸­å¤®é€šè·¯ã®çœŸã‚“ä¸­ï¼‰
                    const startY = topBottomMargin + farmHeight / 2;
                    
                    // çµ‚äº†ç‚¹ï¼ˆã‚¨ãƒªã‚¢ã®ç«¯ã¾ã§ï¼‰
                    let endY;
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢ - ä¸Šç«¯ã¾ã§
                        endY = topBottomMargin + pathWidth;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢ - ä¸‹ç«¯ã¾ã§
                        endY = topBottomMargin + farmHeight - pathWidth;
                    }
                    
                    // å‰é€²ãƒ‘ã‚¹ï¼ˆä¸­å¤®é€šè·¯ã‹ã‚‰ç«¯ã¸ï¼‰
                    currentPaths.push({
                        type: 'forward',
                        startX: laneX,
                        startY: startY,
                        endX: laneX,
                        endY: endY,
                        area: areaNum,
                        lane: laneNum
                    });
                    
                    // ãƒãƒƒã‚¯ãƒ‘ã‚¹ï¼ˆç«¯ã‹ã‚‰ä¸­å¤®é€šè·¯ã¸ï¼‰
                    currentPaths.push({
                        type: 'backward',
                        startX: laneX,
                        startY: endY,
                        endX: laneX,
                        endY: startY,
                        area: areaNum,
                        lane: laneNum
                    });
                    
                    // æ¬¡ã®é€šè·¯ã¸ã®ç§»å‹•ï¼ˆä¸­å¤®é€šè·¯ã‚’é€šã£ã¦ï¼‰
                    if (laneIndex < lanes.length - 1) {
                        const nextLaneX = leftMargin + col * areaWidth + (lanes[laneIndex + 1] - 0.5) * laneWidth;
                        currentPaths.push({
                            type: 'transit',
                            startX: laneX,
                            startY: startY,
                            endX: nextLaneX,
                            endY: startY,
                            area: areaNum
                        });
                    }
                });
                
                // æ¬¡ã®ã‚¨ãƒªã‚¢ã¸ã®ç§»å‹•ï¼ˆä¸­å¤®é€šè·¯ã‚’é€šã£ã¦ï¼‰
                if (areaOrder.indexOf(areaNum) < areaOrder.length - 1) {
                    const nextAreaNum = areaOrder[areaOrder.indexOf(areaNum) + 1];
                    const nextAreaIndex = nextAreaNum - 1;
                    const nextRow = nextAreaIndex < 4 ? 0 : 1;
                    const nextCol = nextAreaIndex % 4;
                    
                    // ç¾åœ¨ã®ã‚¨ãƒªã‚¢ã®æœ€å¾Œã®é€šè·¯
                    const currentLastLane = row === 0 ? 5 : 1;
                    const currentLastLaneX = leftMargin + col * areaWidth + (currentLastLane - 0.5) * (areaWidth / 5);
                    
                    // æ¬¡ã®ã‚¨ãƒªã‚¢ã®æœ€åˆã®é€šè·¯
                    const nextFirstLane = nextRow === 0 ? 2 : 4;
                    const nextFirstLaneX = leftMargin + nextCol * areaWidth + (nextFirstLane - 0.5) * (areaWidth / 5);
                    
                    const currentY = topBottomMargin + farmHeight / 2;
                    
                    currentPaths.push({
                        type: 'transit',
                        startX: currentLastLaneX,
                        startY: currentY,
                        endX: nextFirstLaneX,
                        endY: currentY,
                        area: areaNum,
                        nextArea: nextAreaNum
                    });
                }
            });
        }
        
        // ãŸã¬ãå·ã®å…¨é¢åç©«çµŒè·¯ã‚’è¨ˆç®—
        function calculateTanukiPath() {
            // ã‚¨ãƒªã‚¢ã®é †ç•ª: 8,7,6,5,1,2,3,4
            const areaOrder = [8, 7, 6, 5, 1, 2, 3, 4];
            
            currentPaths = [];
            
            // ãŸã¬ãå·ã®åˆæœŸä½ç½®ã‚’ã‚¨ãƒªã‚¢8é€šè·¯5ã«è¨­å®š
            const initialLaneX = leftMargin + 3 * areaWidth + (5 - 0.5) * (areaWidth / 5);
            const centralY = topBottomMargin + farmHeight / 2;
            updateRobotPosition(2, initialLaneX, centralY + centralPathWidth/2, 90); // å—å‘ã
            
            areaOrder.forEach(areaNum => {
                const areaIndex = areaNum - 1;
                const row = areaIndex < 4 ? 0 : 1;
                const col = areaIndex % 4;
                
                // å—å´ã‚¨ãƒªã‚¢ï¼ˆ5-8ï¼‰ã¯é€šè·¯5,4,3,2ã€åŒ—å´ã‚¨ãƒªã‚¢ï¼ˆ1-4ï¼‰ã¯é€šè·¯1,2,3,4ã‚’ä½¿ç”¨
                let lanes;
                if (row === 1) {
                    // å—å´: é€šè·¯1ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    lanes = [5, 4, 3, 2];
                } else {
                    // åŒ—å´: é€šè·¯5ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    lanes = [1, 2, 3, 4];
                }
                
                lanes.forEach((laneNum, laneIndex) => {
                    // é€šè·¯ã®ä½ç½®ã‚’è¨ˆç®—
                    const laneWidth = areaWidth / 5;
                    const laneX = leftMargin + col * areaWidth + (laneNum - 0.5) * laneWidth;
                    
                    // é–‹å§‹ç‚¹ï¼ˆä¸­å¤®é€šè·¯ã®çœŸã‚“ä¸­ï¼‰
                    const startY = topBottomMargin + farmHeight / 2;
                    
                    // çµ‚äº†ç‚¹ï¼ˆã‚¨ãƒªã‚¢ã®ç«¯ã¾ã§ï¼‰
                    let endY;
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢ - ä¸Šç«¯ã¾ã§
                        endY = topBottomMargin + pathWidth;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢ - ä¸‹ç«¯ã¾ã§
                        endY = topBottomMargin + farmHeight - pathWidth;
                    }
                    
                    // å‰é€²ãƒ‘ã‚¹ï¼ˆä¸­å¤®é€šè·¯ã‹ã‚‰ç«¯ã¸ï¼‰
                    currentPaths.push({
                        type: 'forward',
                        startX: laneX,
                        startY: startY,
                        endX: laneX,
                        endY: endY,
                        area: areaNum,
                        lane: laneNum
                    });
                    
                    // ãƒãƒƒã‚¯ãƒ‘ã‚¹ï¼ˆç«¯ã‹ã‚‰ä¸­å¤®é€šè·¯ã¸ï¼‰
                    currentPaths.push({
                        type: 'backward',
                        startX: laneX,
                        startY: endY,
                        endX: laneX,
                        endY: startY,
                        area: areaNum,
                        lane: laneNum
                    });
                    
                    // æ¬¡ã®é€šè·¯ã¸ã®ç§»å‹•ï¼ˆä¸­å¤®é€šè·¯ã‚’é€šã£ã¦ï¼‰
                    if (laneIndex < lanes.length - 1) {
                        const nextLaneX = leftMargin + col * areaWidth + (lanes[laneIndex + 1] - 0.5) * laneWidth;
                        currentPaths.push({
                            type: 'transit',
                            startX: laneX,
                            startY: startY,
                            endX: nextLaneX,
                            endY: startY,
                            area: areaNum
                        });
                    }
                });
                
                // æ¬¡ã®ã‚¨ãƒªã‚¢ã¸ã®ç§»å‹•ï¼ˆä¸­å¤®é€šè·¯ã‚’é€šã£ã¦ï¼‰
                if (areaOrder.indexOf(areaNum) < areaOrder.length - 1) {
                    const nextAreaNum = areaOrder[areaOrder.indexOf(areaNum) + 1];
                    const nextAreaIndex = nextAreaNum - 1;
                    const nextRow = nextAreaIndex < 4 ? 0 : 1;
                    const nextCol = nextAreaIndex % 4;
                    
                    // ç¾åœ¨ã®ã‚¨ãƒªã‚¢ã®æœ€å¾Œã®é€šè·¯
                    const currentLastLane = row === 1 ? 2 : 4;
                    const currentLastLaneX = leftMargin + col * areaWidth + (currentLastLane - 0.5) * (areaWidth / 5);
                    
                    // æ¬¡ã®ã‚¨ãƒªã‚¢ã®æœ€åˆã®é€šè·¯
                    const nextFirstLane = nextRow === 1 ? 5 : 1;
                    const nextFirstLaneX = leftMargin + nextCol * areaWidth + (nextFirstLane - 0.5) * (areaWidth / 5);
                    
                    const currentY = topBottomMargin + farmHeight / 2;
                    
                    currentPaths.push({
                        type: 'transit',
                        startX: currentLastLaneX,
                        startY: currentY,
                        endX: nextFirstLaneX,
                        endY: currentY,
                        area: areaNum,
                        nextArea: nextAreaNum
                    });
                }
            });
        }
        
        // ï¼’å°ã§å…¨é¢åç©«ã®çµŒè·¯ã‚’è¨ˆç®—
        function calculateDualRobotPath() {
            // ãã¤ã­å·ã¨ãŸã¬ãå·ã®çµŒè·¯ã‚’ä¸¡æ–¹è¨ˆç®—
            calculateKitsunePath();
            const kitsunePaths = [...currentPaths];
            
            calculateTanukiPath();
            const tanukiPaths = [...currentPaths];
            
            // ä¸¡æ–¹ã®çµŒè·¯ã‚’çµåˆã—ã¦ä¿å­˜
            currentPaths = {
                kitsune: kitsunePaths,
                tanuki: tanukiPaths
            };
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ã®å¤‰æ•°
        let animationId = null;
        let currentPathIndex = 0;
        let animationProgress = 0;
        let isAnimating = false;
        
        // ï¼’å°ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ•°
        let currentPathIndexKitsune = 0;
        let currentPathIndexTanuki = 0;
        let animationProgressKitsune = 0;
        let animationProgressTanuki = 0;
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®å¢ƒç•Œç·šç®¡ç†
        let showStaticBoundaries = true; // é™çš„ãªå¢ƒç•Œç·šè¡¨ç¤ºãƒ•ãƒ©ã‚°
        let drawnBoundariesKitsune = new Set(); // ãã¤ã­å·ãŒé€šéã—ãŸå¢ƒç•Œç·š
        let drawnBoundariesTanuki = new Set(); // ãŸã¬ãå·ãŒé€šéã—ãŸå¢ƒç•Œç·š

        function startAnimation() {
            const hasPath = Array.isArray(currentPaths) ? currentPaths.length > 0 : 
                           (currentPaths.kitsune && currentPaths.tanuki);
            if (!hasPath) return;
            
            console.log('ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            isAnimating = true;
            currentPathIndex = 0;
            animationProgress = 0;
            
            // ï¼’å°ãƒ¢ãƒ¼ãƒ‰ç”¨ã®å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentPathIndexKitsune = 0;
            currentPathIndexTanuki = 0;
            animationProgressKitsune = 0;
            animationProgressTanuki = 0;
            
            // å¢ƒç•Œç·šè¡¨ç¤ºã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            showStaticBoundaries = false;
            drawnBoundariesKitsune.clear();
            drawnBoundariesTanuki.clear();
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
            animate();
        }

        function stopAnimation() {
            console.log('ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢');
            isAnimating = false;
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // ãƒ­ãƒœãƒƒãƒˆã‚’åˆæœŸä½ç½®ã«æˆ»ã™
            if (currentPaths.length > 0) {
                // ãƒ—ãƒªã‚»ãƒƒãƒˆã«å¿œã˜ã¦åˆæœŸä½ç½®ã‚’æ±ºå®š
                const presetSelect = document.getElementById('presetSelect');
                const selectedPreset = presetSelect.value;
                
                if (selectedPreset === 'left-robot-only') {
                    // ãã¤ã­å·ã®åˆæœŸä½ç½®
                    const initialLaneX = leftMargin + 0 * areaWidth + (2 - 0.5) * (areaWidth / 5);
                    const centralY = topBottomMargin + farmHeight / 2;
                    updateRobotPosition(1, initialLaneX, centralY - centralPathWidth/2, 270);
                } else if (selectedPreset === 'right-robot-only') {
                    // ãŸã¬ãå·ã®åˆæœŸä½ç½®
                    const initialLaneX = leftMargin + 3 * areaWidth + (5 - 0.5) * (areaWidth / 5);
                    const centralY = topBottomMargin + farmHeight / 2;
                    updateRobotPosition(2, initialLaneX, centralY + centralPathWidth/2, 90);
                }
            }
            
            // å¢ƒç•Œç·šè¡¨ç¤ºã‚’é™çš„ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
            showStaticBoundaries = true;
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function animate() {
            const presetSelect = document.getElementById('presetSelect');
            const selectedPreset = presetSelect.value;
            
            if (selectedPreset === 'two-robots') {
                // ï¼’å°ãƒ¢ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!isAnimating || !currentPaths.kitsune || !currentPaths.tanuki) return;
                
                const speed = 6; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ï¼ˆ2å€é€Ÿï¼‰
                let bothCompleted = true;
                
                // ãã¤ã­å·ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                if (currentPathIndexKitsune < currentPaths.kitsune.length) {
                    bothCompleted = false;
                    const currentPath = currentPaths.kitsune[currentPathIndexKitsune];
                    
                    const startX = currentPath.startX;
                    const startY = currentPath.startY;
                    const endX = currentPath.endX;
                    const endY = currentPath.endY;
                    
                    const x = startX + (endX - startX) * animationProgressKitsune;
                    const y = startY + (endY - startY) * animationProgressKitsune;
                    
                    // ã‚¨ãƒªã‚¢ã®ä½ç½®ã‚’åˆ¤å®š
                    const areaNum = currentPath.area;
                    const isNorthArea = areaNum <= 4;
                    const angle = isNorthArea ? 270 : 90;
                    
                    updateRobotPosition(1, x, y, angle); // ãã¤ã­å·
                    
                    // ãƒ­ãƒœãƒƒãƒˆãŒé€šè·¯ã®ç«¯ã«åˆ°é”ã—ãŸæ™‚ã«å¢ƒç•Œç·šã‚’è¿½åŠ 
                    if (currentPath.type === 'forward' && animationProgressKitsune > 0.9) {
                        const boundaryKey = `${currentPath.area}-${currentPath.lane}`;
                        drawnBoundariesKitsune.add(boundaryKey);
                    }
                    
                    animationProgressKitsune += speed / 100;
                    
                    if (animationProgressKitsune >= 1) {
                        currentPathIndexKitsune++;
                        animationProgressKitsune = 0;
                    }
                }
                
                // ãŸã¬ãå·ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                if (currentPathIndexTanuki < currentPaths.tanuki.length) {
                    bothCompleted = false;
                    const currentPath = currentPaths.tanuki[currentPathIndexTanuki];
                    
                    const startX = currentPath.startX;
                    const startY = currentPath.startY;
                    const endX = currentPath.endX;
                    const endY = currentPath.endY;
                    
                    const x = startX + (endX - startX) * animationProgressTanuki;
                    const y = startY + (endY - startY) * animationProgressTanuki;
                    
                    // ã‚¨ãƒªã‚¢ã®ä½ç½®ã‚’åˆ¤å®š
                    const areaNum = currentPath.area;
                    const isNorthArea = areaNum <= 4;
                    const angle = isNorthArea ? 270 : 90;
                    
                    updateRobotPosition(2, x, y, angle); // ãŸã¬ãå·
                    
                    // ãƒ­ãƒœãƒƒãƒˆãŒé€šè·¯ã®ç«¯ã«åˆ°é”ã—ãŸæ™‚ã«å¢ƒç•Œç·šã‚’è¿½åŠ 
                    if (currentPath.type === 'forward' && animationProgressTanuki > 0.9) {
                        const boundaryKey = `${currentPath.area}-${currentPath.lane}`;
                        drawnBoundariesTanuki.add(boundaryKey);
                    }
                    
                    animationProgressTanuki += speed / 100;
                    
                    if (animationProgressTanuki >= 1) {
                        currentPathIndexTanuki++;
                        animationProgressTanuki = 0;
                    }
                }
                
                if (bothCompleted) {
                    stopAnimation();
                    return;
                }
                
                // åœ°å›³ã‚’å†æç”»
                drawFarm();
                
                // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                animationId = requestAnimationFrame(animate);
            } else {
                // å˜ä½“ãƒ­ãƒœãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!isAnimating || !Array.isArray(currentPaths) || currentPaths.length === 0) return;
                
                const speed = 6; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ï¼ˆ2å€é€Ÿï¼‰
                
                if (currentPathIndex < currentPaths.length) {
                    const currentPath = currentPaths[currentPathIndex];
                    
                    // ç¾åœ¨ã®ãƒ‘ã‚¹ã§ã®ä½ç½®ã‚’è¨ˆç®—
                    const startX = currentPath.startX;
                    const startY = currentPath.startY;
                    const endX = currentPath.endX;
                    const endY = currentPath.endY;
                    
                    const x = startX + (endX - startX) * animationProgress;
                    const y = startY + (endY - startY) * animationProgress;
                    
                    // é€²è¡Œæ–¹å‘ã‚’è¨ˆç®—
                    let angle = 0;
                    
                    // ã‚¨ãƒªã‚¢ã®ä½ç½®ã‚’åˆ¤å®š
                    const areaNum = currentPath.area;
                    const isNorthArea = areaNum <= 4;
                    
                    if (isNorthArea) {
                        angle = 270; // åŒ—ã‚¨ãƒªã‚¢ï¼šåŒ—å‘ã
                    } else {
                        angle = 90; // å—ã‚¨ãƒªã‚¢ï¼šå—å‘ã
                    }
                    
                    // ãƒ­ãƒœãƒƒãƒˆã®ä½ç½®ã‚’æ›´æ–°ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆã«å¿œã˜ã¦ï¼‰
                    if (selectedPreset === 'left-robot-only') {
                        updateRobotPosition(1, x, y, angle); // ãã¤ã­å·
                        // ãƒ­ãƒœãƒƒãƒˆãŒé€šè·¯ã®ç«¯ã«åˆ°é”ã—ãŸæ™‚ã«å¢ƒç•Œç·šã‚’è¿½åŠ 
                        if (currentPath.type === 'forward' && animationProgress > 0.9) {
                            const boundaryKey = `${currentPath.area}-${currentPath.lane}`;
                            drawnBoundariesKitsune.add(boundaryKey);
                        }
                    } else if (selectedPreset === 'right-robot-only') {
                        updateRobotPosition(2, x, y, angle); // ãŸã¬ãå·
                        // ãƒ­ãƒœãƒƒãƒˆãŒé€šè·¯ã®ç«¯ã«åˆ°é”ã—ãŸæ™‚ã«å¢ƒç•Œç·šã‚’è¿½åŠ 
                        if (currentPath.type === 'forward' && animationProgress > 0.9) {
                            const boundaryKey = `${currentPath.area}-${currentPath.lane}`;
                            drawnBoundariesTanuki.add(boundaryKey);
                        }
                    }
                    
                    // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
                    animationProgress += speed / 100;
                    
                    if (animationProgress >= 1) {
                        // æ¬¡ã®ãƒ‘ã‚¹ã«ç§»å‹•
                        currentPathIndex++;
                        animationProgress = 0;
                        
                        if (currentPathIndex >= currentPaths.length) {
                            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†
                            stopAnimation();
                            return;
                        }
                    }
                }
                
                // åœ°å›³ã‚’å†æç”»
                drawFarm();
                
                // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                animationId = requestAnimationFrame(animate);
            }
        }

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
        function toggleAccordion() {
            const toggle = document.querySelector('.accordion-toggle');
            const content = document.getElementById('detailSettings');
            
            toggle.classList.toggle('active');
            content.classList.toggle('active');
        }
        
        // ãƒ­ã‚°ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
        function toggleLogAccordion() {
            const toggle = event.currentTarget;
            const content = document.getElementById('logContent');
            const icon = document.getElementById('logIcon');
            
            toggle.classList.toggle('active');
            content.classList.toggle('active');
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã®å›è»¢
            if (content.classList.contains('active')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // ãƒ­ã‚°è©³ç´°è¡¨ç¤º
        function showLogDetail(logId) {
            const modal = document.getElementById('logDetailModal');
            const content = document.getElementById('logDetailContent');
            
            // ã‚µãƒ³ãƒ—ãƒ«è©³ç´°ãƒ‡ãƒ¼ã‚¿
            const logDetails = {
                1: {
                    date: '2024/12/20',
                    startTime: '08:30',
                    endTime: '11:45',
                    totalHarvest: '85.5kg',
                    t7l: {
                        harvest: '40kg',
                        ripeness: '95%',
                        startArea: 'ã‚¨ãƒªã‚¢1 é€šè·¯1',
                        endArea: 'ã‚¨ãƒªã‚¢5 é€šè·¯1',
                    },
                    t7r: {
                        harvest: '40kg',
                        ripeness: '95%',
                        startArea: 'ã‚¨ãƒªã‚¢8 é€šè·¯5',
                        endArea: 'ã‚¨ãƒªã‚¢4 é€šè·¯5',
                    }
                },
                2: {
                    date: '2024/12/19',
                    startTime: '09:00',
                    endTime: '12:30',
                    totalHarvest: '92.3kg',
                    t7l: {
                        harvest: '40kg',
                        ripeness: '98%',
                        startArea: 'ã‚¨ãƒªã‚¢1 é€šè·¯1',
                        endArea: 'ã‚¨ãƒªã‚¢5 é€šè·¯1',
                    },
                    t7r: {
                        harvest: '40kg',
                        ripeness: '98%',
                        startArea: 'ã‚¨ãƒªã‚¢8 é€šè·¯5',
                        endArea: 'ã‚¨ãƒªã‚¢4 é€šè·¯5',
                    }
                },
                3: {
                    date: '2024/12/18',
                    startTime: '08:00',
                    endTime: '10:45',
                    totalHarvest: '78.8kg',
                    t7l: {
                        harvest: '0kg',
                        ripeness: '-',
                        startArea: '-',
                        endArea: '-',
                        direction: '-'
                    },
                    t7r: {
                        harvest: '80kg',
                        ripeness: '93%',
                        startArea: 'ã‚¨ãƒªã‚¢1 é€šè·¯1',
                        endArea: 'ã‚¨ãƒªã‚¢8 é€šè·¯5',
                    }
                }
            };
            
            const detail = logDetails[logId];
            
            content.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <div><strong>åç©«æ—¥:</strong> ${detail.date}</div>
                        <div><strong>ç·åç©«é‡:</strong> ${detail.totalHarvest}</div>
                        <div><strong>é–‹å§‹æ™‚åˆ»:</strong> ${detail.startTime}</div>
                        <div><strong>çµ‚äº†æ™‚åˆ»:</strong> ${detail.endTime}</div>
                    </div>
                    
                    <div style="border: 2px solid #FF6B6B; border-radius: 5px; padding: 15px;">
                        <h4 style="color: #FF6B6B; margin-bottom: 10px;">ãã¤ã­å· è¨­å®š</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div><strong>åç©«é‡:</strong> ${detail.t7l.harvest}</div>
                            <div><strong>å®Œç†Ÿåº¦:</strong> ${detail.t7l.ripeness}</div>
                            <div><strong>é–‹å§‹ä½ç½®:</strong> ${detail.t7l.startArea}</div>
                            <div><strong>çµ‚äº†ä½ç½®:</strong> ${detail.t7l.endArea}</div>
                        </div>
                    </div>
                    
                    <div style="border: 2px solid #4A90E2; border-radius: 5px; padding: 15px;">
                        <h4 style="color: #4A90E2; margin-bottom: 10px;">ãŸã¬ãå· è¨­å®š</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div><strong>åç©«é‡:</strong> ${detail.t7r.harvest}</div>
                            <div><strong>å®Œç†Ÿåº¦:</strong> ${detail.t7r.ripeness}</div>
                            <div><strong>é–‹å§‹ä½ç½®:</strong> ${detail.t7r.startArea}</div>
                            <div><strong>çµ‚äº†ä½ç½®:</strong> ${detail.t7r.endArea}</div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        // ãƒ­ã‚°è©³ç´°ã‚’é–‰ã˜ã‚‹
        function closeLogDetail() {
            document.getElementById('logDetailModal').style.display = 'none';
        }
        
        // ãƒ­ã‚°è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('logDetailModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeLogDetail();
            }
        });
        
        // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å†…å®¹
        const manualContentHtml = `
            <div style="line-height: 1.8; font-size: 16px;">
                <section style="margin-bottom: 25px;">
                    <h3 style="color: #66bb6a; margin-bottom: 10px;">1. ä½œæ¥­ã®æµã‚Œ</h3>
                    <ol style="padding-left: 20px;">
                        <li><strong>åç©«è¨­å®šï¼š</strong> æœ¬ã‚¢ãƒ—ãƒªã§åç©«è¨ˆç”»ã‚’è¨­å®šã™ã‚‹</li>
                        <li><strong>ãƒ­ãƒœãƒƒãƒˆç§»å‹•ï¼š</strong> ç¾å ´ã§å„ãƒ­ãƒœãƒƒãƒˆã‚’æ“ä½œã—ã¦é–‹å§‹åœ°ç‚¹ã¾ã§é‹ã¶</li>
                        <li><strong>åç©«å®Ÿè¡Œï¼š</strong> ç¾å ´ã§è¨­å®šç¢ºèªå¾Œã€åç©«ã‚’é–‹å§‹ã™ã‚‹</li>
                        <li><strong>ã‚¨ãƒ©ãƒ¼å¯¾å¿œï¼š</strong> ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å¯¾å¿œã¨å¾©æ—§ä½œæ¥­</li>
                        <li><strong>åç©«å¾Œä½œæ¥­ï¼š</strong> ãƒˆãƒãƒˆã‚’å›åã—ã¦ãƒ­ãƒœãƒƒãƒˆã‚’å……é›»ã™ã‚‹</li>
                    </ol>
                </section>
                
                <section style="margin-bottom: 25px;">
                    <h3 style="color: #66bb6a; margin-bottom: 10px;">2. åç©«è¨­å®šæ‰‹é †</h3>
                    <ol style="padding-left: 20px;">
                        <li>å„ãƒ­ãƒœãƒƒãƒˆã®çŠ¶æ…‹ã¨ä½ç½®ã‚’ç¢ºèª</li>
                        <li><strong>ã‚¯ã‚¤ãƒƒã‚¯è¨­å®š</strong>ã‹ã‚‰ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ</li>
                        <li><strong>è©³ç´°è¨­å®š</strong>ã‚’ç¢ºèªãƒ»ç·¨é›†</li>
                        <li>ã€ŒçµŒè·¯ç¢ºèªã€ã§ç§»å‹•è»Œè·¡ã‚’ç¢ºèª</li>
                        <li>ã€Œç¢ºå®šã€ã§å„ãƒ­ãƒœãƒƒãƒˆã«è¨­å®šã‚’é€ä¿¡</li>
                    </ol>
                </section>
                
                <section style="margin-bottom: 25px;">
                    <h3 style="color: #66bb6a; margin-bottom: 10px;">3. ç¾å ´ã§ã®ãƒ­ãƒœãƒƒãƒˆæ“ä½œ</h3>
                    <h4 style="color: #81c784; margin: 10px 0;">ç§»å‹•æº–å‚™</h4>
                    <ul style="padding-left: 20px;">
                        <li>ãƒ­ãƒœãƒƒãƒˆã«ç©ºã®åç©«ã‚«ã‚´ã‚’ã‚»ãƒƒãƒˆ</li>
                        <li>ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã§é–‹å§‹åœ°ç‚¹ã¾ã§ç§»å‹•</li>
                        <li>é€šè·¯ã®éšœå®³ç‰©ã‚’ç¢ºèª</li>
                    </ul>
                    
                    <h4 style="color: #81c784; margin: 10px 0;">åç©«é–‹å§‹</h4>
                    <ul style="padding-left: 20px;">
                        <li>ãƒ­ãƒœãƒƒãƒˆæ­è¼‰ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã§è¨­å®šç¢ºèª</li>
                        <li>ãƒ­ãƒœãƒƒãƒˆæ­è¼‰ç‰©ç†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åç©«é–‹å§‹</li>
                    </ul>
                    
                    <h4 style="color: #81c784; margin: 10px 0;">åç©«å¾Œ</h4>
                    <ul style="padding-left: 20px;">
                        <li>åç©«ã‚«ã‚´ã‚’å›å</li>
                        <li>ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã§å……é›»åœ°ç‚¹ã¾ã§ç§»å‹•</li>
                        <li>å……é›»é–‹å§‹</li>
                    </ul>
                </section>
                
                <section style="margin-bottom: 25px;">
                    <h3 style="color: #66bb6a; margin-bottom: 10px;">4. ãƒãƒƒãƒ—ã®è¦‹æ–¹</h3>
                    <ul style="padding-left: 20px;">
                        <li><strong>ã‚¨ãƒªã‚¢ï¼š</strong> è¾²å ´ã¯8ã¤ã®ã‚¨ãƒªã‚¢ã«åˆ†å‰²ï¼ˆåŒ—å´1-4ã€å—å´5-8ï¼‰</li>
                        <li><strong>é€šè·¯ï¼š</strong> å„ã‚¨ãƒªã‚¢ã«5ã¤ã®é€šè·¯ï¼ˆ1-5ã®ç•ªå·ä»˜ãï¼‰</li>
                        <li><strong>ç•ï¼š</strong> é»„ç·‘è‰²ã®ç·šã§è¡¨ç¤ºï¼ˆå„ã‚¨ãƒªã‚¢4æœ¬ï¼‰</li>
                        <li><strong>ãƒ­ãƒœãƒƒãƒˆä½ç½®ï¼š</strong> ä¸‰è§’å½¢ãƒãƒ¼ã‚«ãƒ¼ï¼ˆãã¤ã­å·:èµ¤ã€ãŸã¬ãå·:é’ï¼‰</li>
                        <li><strong>å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼š</strong> è¥¿å´ï¼ˆå·¦å´ï¼‰ã«é…ç½®</li>
                    </ul>
                </section>
                
                <section style="margin-bottom: 25px; background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h3 style="color: #1565c0; margin-bottom: 10px;">ğŸ’¡ ã‚¨ãƒ©ãƒ¼å¯¾å¿œ</h3>
                    <ul style="padding-left: 20px;">
                        <li><strong>ãƒãƒ³ãƒ‘ãƒ¼åå¿œã§ãƒ­ãƒœãƒƒãƒˆãŒåœæ­¢ã—ãŸå ´åˆï¼š</strong>
                            <ul style="padding-left: 20px;">
                                <li>ãƒ­ãƒœãƒƒãƒˆæ­è¼‰ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®æŒ‡ç¤ºã«å¾“ã„ã€éšœå®³ç‰©ã‚’é™¤å»</li>
                                <li>ã€Œå†é–‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åç©«ã‚’ç¶šè¡Œ</li>
                            </ul>
                        </li>
                        <li><strong>å¸å¼•ã‚¨ãƒ©ãƒ¼ã§ãƒ­ãƒœãƒƒãƒˆãŒåœæ­¢ã—ãŸå ´åˆï¼š</strong>
                            <ul style="padding-left: 20px;">
                                <li>ãƒ­ãƒœãƒƒãƒˆæ­è¼‰ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®æŒ‡ç¤ºã«å¾“ã„ã€å¸å¼•ç‰©ã‚’é™¤å»</li>
                                <li>ã€Œå†é–‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åç©«ã‚’ç¶šè¡Œ</li>
                            </ul>
                        </li>
                        <li><strong>ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ©ãƒ¼ï¼š</strong> Slackã§é–‹ç™ºè€…ã«é€£çµ¡ã™ã‚‹</li>
                        <li><strong>ãƒ­ãƒœãƒƒãƒˆãŒæš´èµ°ã—ãŸå ´åˆï¼š</strong> éå¸¸åœæ­¢ãƒœã‚¿ãƒ³ã¾ãŸã¯ç„¡ç·šãƒªãƒ¢ã‚³ãƒ³ã§å³æ™‚åœæ­¢ã™ã‚‹</li>
                    </ul>
                </section>
                
                <section style="margin-bottom: 25px; background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 10px;">âš ï¸ æ³¨æ„äº‹é …</h3>
                    <ul style="padding-left: 20px;">
                        <li>ä½œæ¥­å‰ã«å¿…ãšå‘¨å›²ã®å®‰å…¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨</li>
                    </ul>
                </section>
                
                <section style="margin-bottom: 25px;">
                    <h3 style="color: #66bb6a; margin-bottom: 10px;">5. éå»ã®åç©«è¨˜éŒ²</h3>
                    <p>éå»ã®åç©«è¨˜éŒ²ã‚’ç¢ºèªã§ãã¾ã™ã€‚å„è¨˜éŒ²ã®ã€Œè©³ç´°ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ãã®æ™‚ã®è¨­å®šå†…å®¹ï¼ˆé–‹å§‹/çµ‚äº†ä½ç½®ã€åç©«é‡ã€å®Œç†Ÿåº¦ãªã©ï¼‰ã‚’ç¢ºèªå¯èƒ½ã§ã™ã€‚</p>
                </section>
            </div>
        `;

        // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è¡¨ç¤º
        function showManual() {
            document.getElementById('manualContent').innerHTML = manualContentHtml;
            document.getElementById('manualModal').style.display = 'block';
        }
        
        // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeManual() {
            document.getElementById('manualModal').style.display = 'none';
        }
        
        // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('manualModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeManual();
            }
        });
        
        // é€ä¿¡çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSendResult() {
            document.getElementById('sendResultModal').style.display = 'none';
        }
        
        // é€ä¿¡çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('sendResultModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeSendResult();
            }
        });
        
        // è¨­å®šã‚’å„ãƒ­ãƒœãƒƒãƒˆã«é€ä¿¡
        function sendSettings() {
            // è©³ç´°è¨­å®šã‹ã‚‰ç¾åœ¨ã®å€¤ã‚’å–å¾—
            const settings = {
                t7l: {
                    startArea: document.getElementById('startArea1').value,
                    startLane: document.getElementById('startLane1').value,
                    endArea: document.getElementById('endArea1').value,
                    endLane: document.getElementById('endLane1').value,
                    harvest: document.getElementById('harvest1').value,
                    ripeness: document.getElementById('ripeness1').value
                },
                t7r: {
                    startArea: document.getElementById('startArea2').value,
                    startLane: document.getElementById('startLane2').value,
                    endArea: document.getElementById('endArea2').value,
                    endLane: document.getElementById('endLane2').value,
                    harvest: document.getElementById('harvest2').value,
                    ripeness: document.getElementById('ripeness2').value
                }
            };
            
            // é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²
            const now = new Date();
            const sendTime = now.toLocaleString('ja-JP');
            
            // é€ä¿¡çµæœã®HTMLç”Ÿæˆ
            const resultHtml = `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="font-size: 18px; color: #2e7d32; margin-bottom: 10px;">
                        <strong>âœ… é€ä¿¡æˆåŠŸ</strong>
                    </p>
                    <p style="font-size: 16px; color: #666;">
                        é€ä¿¡æ™‚åˆ»: ${sendTime}
                    </p>
                </div>
                
                <div style="border: 2px solid #FF6B6B; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h3 style="color: #FF6B6B; margin-bottom: 12px; font-size: 20px;">
                        <span style="display: inline-block; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #FF6B6B; margin-right: 8px;"></span>
                        ãã¤ã­å· é€ä¿¡å†…å®¹
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 16px;">
                        <div><strong>é–‹å§‹ä½ç½®:</strong> ã‚¨ãƒªã‚¢${settings.t7l.startArea} é€šè·¯${settings.t7l.startLane}</div>
                        <div><strong>çµ‚äº†ä½ç½®:</strong> ã‚¨ãƒªã‚¢${settings.t7l.endArea} é€šè·¯${settings.t7l.endLane}</div>
                        <div><strong>å›è»¢æ–¹å‘:</strong> ${settings.t7l.direction}</div>
                        <div><strong>åç©«é‡:</strong> ${settings.t7l.harvest}kg</div>
                        <div><strong>å®Œç†Ÿåº¦:</strong> ${settings.t7l.ripeness}%</div>
                    </div>
                </div>
                
                <div style="border: 2px solid #4A90E2; border-radius: 8px; padding: 15px;">
                    <h3 style="color: #4A90E2; margin-bottom: 12px; font-size: 20px;">
                        <span style="display: inline-block; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #4A90E2; margin-right: 8px;"></span>
                        ãŸã¬ãå· é€ä¿¡å†…å®¹
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 16px;">
                        <div><strong>é–‹å§‹ä½ç½®:</strong> ã‚¨ãƒªã‚¢${settings.t7r.startArea} é€šè·¯${settings.t7r.startLane}</div>
                        <div><strong>çµ‚äº†ä½ç½®:</strong> ã‚¨ãƒªã‚¢${settings.t7r.endArea} é€šè·¯${settings.t7r.endLane}</div>
                        <div><strong>å›è»¢æ–¹å‘:</strong> ${settings.t7r.direction}</div>
                        <div><strong>åç©«é‡:</strong> ${settings.t7r.harvest}kg</div>
                        <div><strong>å®Œç†Ÿåº¦:</strong> ${settings.t7r.ripeness}%</div>
                    </div>
                </div>
            `;
            
            // çµæœã‚’è¡¨ç¤º
            document.getElementById('sendResultContent').innerHTML = resultHtml;
            document.getElementById('sendResultModal').style.display = 'block';
            
            // ã“ã“ã§å®Ÿéš›ã®é€ä¿¡å‡¦ç†ã‚’è¡Œã†ï¼ˆAPIå‘¼ã³å‡ºã—ãªã©ï¼‰
            console.log('é€ä¿¡è¨­å®š:', settings);
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®š
        function applyPreset() {
            const presetSelect = document.getElementById('presetSelect');
            const selectedPreset = presetSelect.value;
            
            // ä¸€æ™‚çš„ã«selectè¦ç´ ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã‹ã‚‰è¨­å®š
            const selects = document.querySelectorAll('#detailSettings select');
            const wasDisabled = [];
            
            // ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ã€ä¸€æ™‚çš„ã«æœ‰åŠ¹åŒ–
            selects.forEach((select, index) => {
                wasDisabled[index] = select.disabled;
                select.disabled = false;
            });
            
            if (selectedPreset === 'two-robots') {
                // 2å°ã§å…¨é¢åç©«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰
                // ãã¤ã­å·: ã‚¨ãƒªã‚¢1ã‹ã‚‰5é€šè·¯1ã¾ã§æ‹…å½“
                document.getElementById('startArea1').value = '1';
                document.getElementById('startLane1').value = '1';
                document.getElementById('endArea1').value = '5';
                document.getElementById('endLane1').value = '1';
                
                // ãŸã¬ãå·: ã‚¨ãƒªã‚¢8é€šè·¯5ã‹ã‚‰4é€šè·¯5ã¾ã§æ‹…å½“
                document.getElementById('startArea2').value = '8';
                document.getElementById('startLane2').value = '5';
                document.getElementById('endArea2').value = '4';
                document.getElementById('endLane2').value = '5';
            } else if (selectedPreset === 'left-robot-only') {
                // ãã¤ã­å·ã§å…¨é¢åç©«
                // ãã¤ã­å·: å…¨ã‚¨ãƒªã‚¢ã‚’æ‹…å½“
                document.getElementById('startArea1').value = '1';
                document.getElementById('startLane1').value = '1';
                document.getElementById('endArea1').value = '8';
                document.getElementById('endLane1').value = '5';
                
                // ãŸã¬ãå·: ç„¡åŠ¹åŒ–ï¼ˆåŒã˜ä½ç½®ã«è¨­å®šï¼‰
                document.getElementById('startArea2').value = '8';
                document.getElementById('startLane2').value = '5';
                document.getElementById('endArea2').value = '8';
                document.getElementById('endLane2').value = '5';
            } else if (selectedPreset === 'right-robot-only') {
                // ãŸã¬ãå·ã§å…¨é¢åç©«
                // ãã¤ã­å·: ç„¡åŠ¹åŒ–ï¼ˆåŒã˜ä½ç½®ã«è¨­å®šï¼‰
                document.getElementById('startArea1').value = '1';
                document.getElementById('startLane1').value = '1';
                document.getElementById('endArea1').value = '1';
                document.getElementById('endLane1').value = '1';
                
                // ãŸã¬ãå·: å…¨ã‚¨ãƒªã‚¢ã‚’æ‹…å½“
                document.getElementById('startArea2').value = '1';
                document.getElementById('startLane2').value = '1';
                document.getElementById('endArea2').value = '8';
                document.getElementById('endLane2').value = '5';
            }
            // ã‚«ã‚¹ã‚¿ãƒ åç©«1,2ã®å ´åˆã¯ç¾åœ¨ã®è¨­å®šã‚’ç¶­æŒ
            
            // å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
            selects.forEach((select, index) => {
                select.disabled = wasDisabled[index];
            });
            
            console.log('ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šã‚’é©ç”¨:', selectedPreset);
        }

        // ãƒãƒƒãƒ—æç”»
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šï¼ˆ1m = 15px - 1.5å€ã«æ‹¡å¤§ï¼‰
        const scale = 15;
        const farmWidth = 32 * scale; // 480px
        const farmHeight = 62.5 * scale; // 937.5px
        const centralPathWidth = 2.5 * scale; // 37.5px
        const ridgeWidth = 0.6 * scale; // 9px
        const ridgeLength = 30 * scale; // 450px
        const pathWidth = 1 * scale; // 15px
        const pillarSize = 0.3 * scale; // 4.5px
        const areaWidth = 8 * scale; // 120px
        
        // ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ ï¼ˆå……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³åˆ†ã‚‚è€ƒæ…®ï¼‰
        const leftMargin = 98; // å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®å¹…ã„ä½™ç™½ï¼ˆ1.5å€ï¼‰
        const rightMargin = 23; // å³å´ã®ç´°ã„ä½™ç™½ï¼ˆ1.5å€ï¼‰
        const topBottomMargin = 23; // ä¸Šä¸‹ã®ä½™ç™½ï¼ˆ1.5å€ï¼‰
        canvas.width = farmWidth + leftMargin + rightMargin;
        canvas.height = farmHeight + topBottomMargin * 2;
        
        // è‰²ã®å®šç¾©
        const colors = {
            ridge: '#90EE90',        // é»„ç·‘è‰²
            centralPath: '#F5F5F5',  // éå¸¸ã«è–„ã„ã‚°ãƒ¬ãƒ¼ï¼ˆã»ã¼ç™½ï¼‰
            pathBetween: '#FFFFFF',  // ç™½è‰²ï¼ˆç•é–“é€šè·¯ï¼‰
            pillar: '#666666',       // æ¿ƒã„ã‚°ãƒ¬ãƒ¼
            border: '#333333',       // é»’
            background: '#FFFFFF',   // ç™½
            text: '#000000',         // é»’ï¼ˆãƒ†ã‚­ã‚¹ãƒˆç”¨ï¼‰
            chargingStation: '#FFFFFF', // å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç™½è‰²ï¼‰
            robot1: '#FF6B6B',       // ãã¤ã­å·ï¼ˆèµ¤è‰²ï¼‰
            robot2: '#4A90E2'        // ãŸã¬ãå·ï¼ˆé’è‰²ï¼‰
        };
        
        // ãƒ­ãƒœãƒƒãƒˆã®ä½ç½®æƒ…å ±ï¼ˆå……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å†…ï¼‰
        let robotPositions = {
            robot1: { x: leftMargin - 60, y: topBottomMargin + farmHeight / 2 - 15, angle: 0 }, // ãã¤ã­å· - å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å†…
            robot2: { x: leftMargin - 30, y: topBottomMargin + farmHeight / 2 + 15, angle: 0 }  // ãŸã¬ãå· - å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å†…
        };
        
        function drawFarm() {
            // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
            ctx.fillStyle = colors.background;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // è¾²å ´å…¨ä½“ã‚’èŒ¶è‰²ã§å¡—ã‚Šã¤ã¶ã™ï¼ˆé€šè·¯ã®ãƒ™ãƒ¼ã‚¹ï¼‰
            ctx.fillStyle = colors.pathBetween;
            ctx.fillRect(leftMargin, topBottomMargin, farmWidth, farmHeight);
            
            // æ±è¥¿ä¸­å¤®é€šè·¯ã‚’æç”»
            const centralPathY = topBottomMargin + (farmHeight - centralPathWidth) / 2;
            ctx.fillStyle = colors.centralPath;
            ctx.fillRect(leftMargin, centralPathY, farmWidth, centralPathWidth);
            
            // ã‚¨ãƒªã‚¢ã¨ç•ã‚’æç”»
            for (let i = 0; i < 8; i++) {
                const row = i < 4 ? 0 : 1;
                const col = i % 4;
                const areaX = leftMargin + col * areaWidth;
                let areaY;
                
                if (row === 0) {
                    // åŒ—å´ã‚¨ãƒªã‚¢ï¼ˆ1-4ï¼‰
                    areaY = topBottomMargin;
                } else {
                    // å—å´ã‚¨ãƒªã‚¢ï¼ˆ5-8ï¼‰- ä¸­å¤®é€šè·¯ã«ç›´æ¥æ¥ç¶š
                    areaY = centralPathY + centralPathWidth;
                }
                
                // ç•ã‚’æç”»ï¼ˆã‚¨ãƒªã‚¢å¹…ã‚’5ç­‰åˆ†ã—ã¦ã€æŸ±ã¨æŸ±ã®é–“ã«ç•ã‚’é…ç½®ï¼‰
                // ã‚¨ãƒªã‚¢å¹… = 120pxã€5ã¤ã®é€šè·¯ï¼ˆå„24pxï¼‰ã«åˆ†å‰²
                const laneWidth = areaWidth / 5; // 24px per lane
                for (let j = 0; j < 4; j++) {
                    // å„ç•ã‚’é€šè·¯ã®ä¸­å¤®ã«é…ç½®ï¼ˆé€šè·¯1ã¨5ã‚’é™¤ãï¼‰
                    const ridgeX = areaX + (j + 1) * laneWidth - ridgeWidth / 2;
                    let ridgeY, adjustedRidgeLength;
                    
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢ - ä¸Šç«¯ã‹ã‚‰ä¸­å¤®é€šè·¯ã¾ã§
                        ridgeY = areaY + pathWidth;
                        adjustedRidgeLength = centralPathY - ridgeY;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢ - ä¸­å¤®é€šè·¯ã‹ã‚‰ä¸‹ç«¯ã¾ã§
                        ridgeY = centralPathY + centralPathWidth;
                        adjustedRidgeLength = (topBottomMargin + farmHeight) - ridgeY - pathWidth;
                    }
                    
                    ctx.fillStyle = colors.ridge;
                    ctx.fillRect(ridgeX, ridgeY, ridgeWidth, adjustedRidgeLength);
                }
            }
            
            // æŸ±ã‚’æç”»
            ctx.fillStyle = colors.pillar;
            for (let i = 0; i <= 4; i++) {
                for (let j = 0; j <= 25; j++) {
                    const x = leftMargin + i * areaWidth;
                    const y = topBottomMargin + j * 2.5 * scale;
                    ctx.fillRect(x - pillarSize / 2, y - pillarSize / 2, pillarSize, pillarSize);
                }
            }
            
            // è¾²å ´ã®å¤–æ 
            ctx.strokeStyle = colors.border;
            ctx.lineWidth = 2;
            ctx.strokeRect(leftMargin, topBottomMargin, farmWidth, farmHeight);
            
            // å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»ï¼ˆè¥¿å´ã€ä¸­å¤®é€šè·¯ã®å·¦ç«¯ã«æ¥ã—ã¦ï¼‰
            const chargingStationSize = 90; // 1.5å€ã®ã‚µã‚¤ã‚º
            const chargingStationX = leftMargin - chargingStationSize; // å³ç«¯ãŒä¸­å¤®é€šè·¯ã®å·¦ç«¯ã«æ¥ã™ã‚‹
            const chargingStationY = centralPathY + (centralPathWidth - chargingStationSize) / 2;
            
            // å……é›»å ´æ‰€ã®ãƒ©ãƒ™ãƒ«ï¼ˆä¸Šã«è¡¨ç¤ºï¼‰
            ctx.fillStyle = colors.text;
            ctx.font = 'bold 21px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('å……é›»å ´æ‰€', chargingStationX + chargingStationSize / 2, chargingStationY - 8);
            
            // å……é›»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“
            ctx.fillStyle = colors.chargingStation;
            ctx.fillRect(chargingStationX, chargingStationY, chargingStationSize, chargingStationSize);
            ctx.strokeStyle = colors.border;
            ctx.lineWidth = 2;
            ctx.strokeRect(chargingStationX, chargingStationY, chargingStationSize, chargingStationSize);
            
            // æ–¹ä½ãƒãƒ¼ã‚¯ã‚’è¡¨ç¤º
            drawCompass();
            
            // ã‚¨ãƒªã‚¢ç•ªå·ã‚’æœ€å‰é¢ã«è¡¨ç¤ºï¼ˆå„ã‚¨ãƒªã‚¢ã®å—åŒ—æ–¹å‘ã®ä¸­å¤®ï¼‰
            ctx.fillStyle = colors.text;
            ctx.font = 'bold 21px Arial';
            ctx.textAlign = 'left';
            for (let i = 0; i < 8; i++) {
                const row = i < 4 ? 0 : 1;
                const col = i % 4;
                const areaX = leftMargin + col * areaWidth + areaWidth / 2 - 30;
                let textY;
                
                if (row === 0) {
                    // åŒ—å´ã‚¨ãƒªã‚¢ï¼ˆ1-4ï¼‰- åŒ—ç«¯ã‹ã‚‰ä¸­å¤®é€šè·¯ã¾ã§ã®ä¸­å¤®
                    const areaTop = topBottomMargin;
                    const areaBottom = centralPathY;
                    textY = (areaTop + areaBottom) / 2 + 3;
                } else {
                    // å—å´ã‚¨ãƒªã‚¢ï¼ˆ5-8ï¼‰- ä¸­å¤®é€šè·¯ã‹ã‚‰å—ç«¯ã¾ã§ã®ä¸­å¤®
                    const areaTop = centralPathY + centralPathWidth;
                    const areaBottom = topBottomMargin + farmHeight;
                    textY = (areaTop + areaBottom) / 2 + 3;
                }
                
                ctx.fillText(`ã‚¨ãƒªã‚¢${i + 1}`, areaX, textY);
            }
            
            // é€šè·¯ç•ªå·ã‚’è¡¨ç¤ºï¼ˆå„ã‚¨ãƒªã‚¢ã®é€šè·¯ã«å¯¾ã—ã¦ï¼‰
            ctx.fillStyle = colors.text;
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            
            for (let i = 0; i < 8; i++) {
                const row = i < 4 ? 0 : 1;
                const col = i % 4;
                const areaX = leftMargin + col * areaWidth;
                
                // å„ã‚¨ãƒªã‚¢ã«5ã¤ã®é€šè·¯ç•ªå·ã‚’è¡¨ç¤º
                const laneWidth = areaWidth / 5; // ã‚¨ãƒªã‚¢å¹…ã‚’5ç­‰åˆ†
                for (let j = 0; j < 5; j++) {
                    // å„é€šè·¯ã®ä¸­å¤®ã«ç•ªå·ã‚’é…ç½®
                    const laneX = areaX + (j + 0.5) * laneWidth;
                    
                    let laneY;
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢ - ä¸Šéƒ¨ã«è¡¨ç¤º
                        laneY = topBottomMargin + 40;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢ - ä¸‹éƒ¨ã«è¡¨ç¤º
                        laneY = topBottomMargin + farmHeight - 20;
                    }
                    
                    // é€šè·¯ç•ªå·ã‚’è¡¨ç¤º
                    ctx.fillStyle = colors.text;
                    ctx.fillText(`${j + 1}`, laneX, laneY);
                }
            }
            
            // çµŒè·¯ã‚’æç”»ï¼ˆãƒ­ãƒœãƒƒãƒˆã‚ˆã‚Šå…ˆã«æç”»ã—ã¦èƒŒæ™¯ã«é…ç½®ï¼‰
            // const hasPath = Array.isArray(currentPaths) ? currentPaths.length > 0 : 
            //                (currentPaths.kitsune && currentPaths.tanuki);
            // if (hasPath) {
            //     drawPaths();
            // }
            
            // ç•å¢ƒç•Œç·šã‚’æç”»
            const hasPath = Array.isArray(currentPaths) ? currentPaths.length > 0 : 
                           (currentPaths.kitsune && currentPaths.tanuki);
            if (hasPath) {
                drawFurrowBoundaries();
            }
            
            // ãƒ­ãƒœãƒƒãƒˆã‚’æç”»
            // çµŒè·¯è¡¨ç¤ºä¸­ã¯è©²å½“ãƒ­ãƒœãƒƒãƒˆã‚’è–„ã„è‰²ã§è¡¨ç¤º
            const presetSelect = document.getElementById('presetSelect');
            const selectedPreset = presetSelect.value;
            
            let robot1Color = colors.robot1;
            let robot2Color = colors.robot2;
            
            if (currentPaths.length > 0) {
                if (selectedPreset === 'left-robot-only') {
                    robot1Color = '#FFB3B3'; // ãã¤ã­å·ã‚’è–„ã„è‰²
                } else if (selectedPreset === 'right-robot-only') {
                    robot2Color = '#B3D4FF'; // ãŸã¬ãå·ã‚’è–„ã„è‰²
                }
            }
            
            drawRobot(1, robotPositions.robot1.x, robotPositions.robot1.y, robotPositions.robot1.angle, robot1Color);
            drawRobot(2, robotPositions.robot2.x, robotPositions.robot2.y, robotPositions.robot2.angle, robot2Color);
        }
        
        // çµŒè·¯ã‚’æç”»ã™ã‚‹é–¢æ•°
        function drawPaths() {
            ctx.save();
            
            // ç‚¹ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
            ctx.setLineDash([5, 5]); // 5pxæç”»ã€5pxç©ºç™½
            ctx.lineWidth = 2;
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆã«å¿œã˜ã¦çµŒè·¯ã®è‰²ã‚’å¤‰æ›´
            const presetSelect = document.getElementById('presetSelect');
            const selectedPreset = presetSelect.value;
            
            if (selectedPreset === 'two-robots' && currentPaths.kitsune && currentPaths.tanuki) {
                // ï¼’å°ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ä¸¡æ–¹ã®çµŒè·¯ã‚’æç”»
                
                // ãã¤ã­å·ã®çµŒè·¯ï¼ˆèµ¤è‰²ï¼‰
                ctx.strokeStyle = '#FF6B6B';
                currentPaths.kitsune.forEach(path => {
                    ctx.beginPath();
                    ctx.moveTo(path.startX, path.startY);
                    ctx.lineTo(path.endX, path.endY);
                    ctx.stroke();
                });
                
                // ãŸã¬ãå·ã®çµŒè·¯ï¼ˆé’è‰²ï¼‰
                ctx.strokeStyle = '#4A90E2';
                currentPaths.tanuki.forEach(path => {
                    ctx.beginPath();
                    ctx.moveTo(path.startX, path.startY);
                    ctx.lineTo(path.endX, path.endY);
                    ctx.stroke();
                });
            } else if (Array.isArray(currentPaths)) {
                // å˜ä½“ãƒ­ãƒœãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                let pathColor = '#FF6B6B'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãã¤ã­å·ã®èµ¤è‰²
                
                if (selectedPreset === 'right-robot-only') {
                    pathColor = '#4A90E2'; // ãŸã¬ãå·ã¯é’è‰²
                }
                
                ctx.strokeStyle = pathColor;
                currentPaths.forEach(path => {
                    ctx.beginPath();
                    ctx.moveTo(path.startX, path.startY);
                    ctx.lineTo(path.endX, path.endY);
                    ctx.stroke();
                });
            }
            
            ctx.restore();
        }
        
        // ç•å¢ƒç•Œç·šã‚’æç”»ã™ã‚‹é–¢æ•°
        function drawFurrowBoundaries() {
            const presetSelect = document.getElementById('presetSelect');
            const selectedPreset = presetSelect.value;
            
            if (showStaticBoundaries) {
                // é™çš„ãªå¢ƒç•Œç·šè¡¨ç¤º
                if (selectedPreset === 'left-robot-only') {
                    drawKitsuneFurrowBoundaries();
                } else if (selectedPreset === 'right-robot-only') {
                    drawTanukiFurrowBoundaries();
                } else if (selectedPreset === 'two-robots') {
                    drawKitsuneFurrowBoundaries();
                    drawTanukiFurrowBoundaries();
                }
            } else {
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®å¢ƒç•Œç·šè¡¨ç¤º
                if (selectedPreset === 'left-robot-only' || selectedPreset === 'two-robots') {
                    drawAnimatedKitsuneBoundaries();
                }
                if (selectedPreset === 'right-robot-only' || selectedPreset === 'two-robots') {
                    drawAnimatedTanukiBoundaries();
                }
            }
        }
        
        // ãã¤ã­å·ã®ç•å¢ƒç•Œç·šã‚’æç”»
        function drawKitsuneFurrowBoundaries() {
            ctx.save();
            
            // ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
            ctx.strokeStyle = '#FF6B6B'; // èµ¤è‰²
            ctx.lineWidth = 2;
            
            // ã‚¨ãƒªã‚¢ã®é †ç•ª: 1,2,3,4,8,7,6,5
            const areaOrder = [1, 2, 3, 4, 8, 7, 6, 5];
            
            areaOrder.forEach(areaNum => {
                const areaIndex = areaNum - 1;
                const row = areaIndex < 4 ? 0 : 1;
                const col = areaIndex % 4;
                
                // ãã¤ã­å·ã®å®Ÿéš›ã®é€šè·¯é…ç½®ã¨åŒã˜ã«ã™ã‚‹
                let lanes;
                if (row === 0) {
                    // åŒ—å´ã‚¨ãƒªã‚¢: é€šè·¯1ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦2,3,4,5
                    lanes = [2, 3, 4, 5];
                } else {
                    // å—å´ã‚¨ãƒªã‚¢: é€šè·¯5ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦4,3,2,1
                    lanes = [4, 3, 2, 1];
                }
                
                lanes.forEach((laneNum) => {
                    // é€šè·¯ã®ä½ç½®ã‚’è¨ˆç®—
                    const laneWidth = areaWidth / 5;
                    const laneX = leftMargin + col * areaWidth + (laneNum - 0.5) * laneWidth;
                    
                    // ç•ã¨é€šè·¯ã®å¢ƒç•Œç·šï¼ˆåŒ—å´ã¯å·¦å´ã€å—å´ã¯å³å´ï¼‰
                    let boundaryX;
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢: é€šè·¯ã®å·¦å´ï¼ˆ2pxé€šè·¯å¯„ã‚Šï¼‰
                        boundaryX = laneX - laneWidth / 2 + 4;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢: é€šè·¯ã®å³å´ï¼ˆ2pxé€šè·¯å¯„ã‚Šï¼‰
                        boundaryX = laneX + laneWidth / 2 - 4;
                    }
                    
                    // Yåº§æ¨™ã®ç¯„å›²
                    let startY, endY;
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢
                        startY = topBottomMargin + pathWidth;
                        endY = topBottomMargin + farmHeight / 2 - centralPathWidth / 2;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢
                        startY = topBottomMargin + farmHeight / 2 + centralPathWidth / 2;
                        endY = topBottomMargin + farmHeight - pathWidth;
                    }
                    
                    // å¢ƒç•Œç·šã‚’ç›´ç·šã§æç”»
                    ctx.beginPath();
                    ctx.moveTo(boundaryX, startY);
                    ctx.lineTo(boundaryX, endY);
                    ctx.stroke();
                });
            });
            
            ctx.restore();
        }
        
        // ãŸã¬ãå·ã®ç•å¢ƒç•Œç·šã‚’æç”»
        function drawTanukiFurrowBoundaries() {
            ctx.save();
            
            // ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
            ctx.strokeStyle = '#4A90E2'; // é’è‰²
            ctx.lineWidth = 2;
            
            // ã‚¨ãƒªã‚¢ã®é †ç•ª: 8,7,6,5,1,2,3,4
            const areaOrder = [8, 7, 6, 5, 1, 2, 3, 4];
            
            areaOrder.forEach(areaNum => {
                const areaIndex = areaNum - 1;
                const row = areaIndex < 4 ? 0 : 1;
                const col = areaIndex % 4;
                
                // ãŸã¬ãå·ã®å®Ÿéš›ã®é€šè·¯é…ç½®ã¨åŒã˜ã«ã™ã‚‹
                let lanes;
                if (row === 0) {
                    // åŒ—å´ã‚¨ãƒªã‚¢: é€šè·¯5ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦1,2,3,4
                    lanes = [1, 2, 3, 4];
                } else {
                    // å—å´ã‚¨ãƒªã‚¢: é€šè·¯1ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦5,4,3,2
                    lanes = [5, 4, 3, 2];
                }
                
                lanes.forEach((laneNum) => {
                    // é€šè·¯ã®ä½ç½®ã‚’è¨ˆç®—
                    const laneWidth = areaWidth / 5;
                    const laneX = leftMargin + col * areaWidth + (laneNum - 0.5) * laneWidth;
                    
                    // ç•ã¨é€šè·¯ã®å¢ƒç•Œç·šï¼ˆåŒ—å´ã¯å³å´ã€å—å´ã¯å·¦å´ï¼‰
                    let boundaryX;
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢: é€šè·¯ã®å³å´ï¼ˆ2pxé€šè·¯å¯„ã‚Šï¼‰
                        boundaryX = laneX + laneWidth / 2 - 4;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢: é€šè·¯ã®å·¦å´ï¼ˆ2pxé€šè·¯å¯„ã‚Šï¼‰
                        boundaryX = laneX - laneWidth / 2 + 4;
                    }
                    
                    // Yåº§æ¨™ã®ç¯„å›²
                    let startY, endY;
                    if (row === 0) {
                        // åŒ—å´ã‚¨ãƒªã‚¢
                        startY = topBottomMargin + pathWidth;
                        endY = topBottomMargin + farmHeight / 2 - centralPathWidth / 2;
                    } else {
                        // å—å´ã‚¨ãƒªã‚¢
                        startY = topBottomMargin + farmHeight / 2 + centralPathWidth / 2;
                        endY = topBottomMargin + farmHeight - pathWidth;
                    }
                    
                    // å¢ƒç•Œç·šã‚’ç›´ç·šã§æç”»
                    ctx.beginPath();
                    ctx.moveTo(boundaryX, startY);
                    ctx.lineTo(boundaryX, endY);
                    ctx.stroke();
                });
            });
            
            ctx.restore();
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ãã¤ã­å·å¢ƒç•Œç·šã‚’æç”»
        function drawAnimatedKitsuneBoundaries() {
            if (drawnBoundariesKitsune.size === 0) return;
            
            ctx.save();
            ctx.strokeStyle = '#FF6B6B';
            ctx.lineWidth = 2;
            
            drawnBoundariesKitsune.forEach(boundaryKey => {
                const [areaNum, laneNum] = boundaryKey.split('-').map(Number);
                drawSingleBoundary(areaNum, laneNum, 'kitsune');
            });
            
            ctx.restore();
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ãŸã¬ãå·å¢ƒç•Œç·šã‚’æç”»
        function drawAnimatedTanukiBoundaries() {
            if (drawnBoundariesTanuki.size === 0) return;
            
            ctx.save();
            ctx.strokeStyle = '#4A90E2';
            ctx.lineWidth = 2;
            
            drawnBoundariesTanuki.forEach(boundaryKey => {
                const [areaNum, laneNum] = boundaryKey.split('-').map(Number);
                drawSingleBoundary(areaNum, laneNum, 'tanuki');
            });
            
            ctx.restore();
        }
        
        // å˜ä¸€ã®å¢ƒç•Œç·šã‚’æç”»
        function drawSingleBoundary(areaNum, laneNum, robotType) {
            const areaIndex = areaNum - 1;
            const row = areaIndex < 4 ? 0 : 1;
            const col = areaIndex % 4;
            
            const laneWidth = areaWidth / 5;
            const laneX = leftMargin + col * areaWidth + (laneNum - 0.5) * laneWidth;
            
            let boundaryX;
            if (robotType === 'kitsune') {
                if (row === 0) {
                    boundaryX = laneX - laneWidth / 2 + 4;
                } else {
                    boundaryX = laneX + laneWidth / 2 - 4;
                }
            } else { // tanuki
                if (row === 0) {
                    boundaryX = laneX + laneWidth / 2 - 4;
                } else {
                    boundaryX = laneX - laneWidth / 2 + 4;
                }
            }
            
            let startY, endY;
            if (row === 0) {
                startY = topBottomMargin + pathWidth;
                endY = topBottomMargin + farmHeight / 2 - centralPathWidth / 2;
            } else {
                startY = topBottomMargin + farmHeight / 2 + centralPathWidth / 2;
                endY = topBottomMargin + farmHeight - pathWidth;
            }
            
            ctx.beginPath();
            ctx.moveTo(boundaryX, startY);
            ctx.lineTo(boundaryX, endY);
            ctx.stroke();
        }
        
        // æ–¹ä½ãƒãƒ¼ã‚¯ã‚’æç”»
        function drawCompass() {
            if (compassImg.complete && compassImg.naturalHeight !== 0) {
                // å…ƒç”»åƒã®1/8ã®ã‚µã‚¤ã‚ºã§è¡¨ç¤º
                const imgWidth = compassImg.naturalWidth / 8;
                const imgHeight = compassImg.naturalHeight / 8;
                const compassX = 10;
                const compassY = 10;
                
                ctx.drawImage(compassImg, compassX, compassY, imgWidth, imgHeight);
            }
        }
        
        // ãƒ­ãƒœãƒƒãƒˆã‚’äºŒç­‰è¾ºä¸‰è§’å½¢ã§æç”»
        function drawRobot(robotId, x, y, angle, color) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle * Math.PI / 180);
            
            // äºŒç­‰è¾ºä¸‰è§’å½¢ã®ã‚µã‚¤ã‚º
            const size = 12;
            
            ctx.beginPath();
            ctx.moveTo(size, 0);           // å…ˆç«¯ï¼ˆé€²è¡Œæ–¹å‘ï¼‰
            ctx.lineTo(-size/2, -size/2);  // å·¦ä¸‹
            ctx.lineTo(-size/2, size/2);   // å·¦ä¸Š
            ctx.closePath();
            
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = colors.border;
            ctx.lineWidth = 1;
            ctx.stroke();
            
            
            ctx.restore();
        }
        
        // ãƒ­ãƒœãƒƒãƒˆã®ä½ç½®ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateRobotPosition(robotId, x, y, angle = 0) {
            robotPositions[`robot${robotId}`] = { x, y, angle };
            drawFarm(); // ãƒãƒƒãƒ—ã‚’å†æç”»
        }
        
        // æ–¹ä½ãƒãƒ¼ã‚¯ç”»åƒã‚’äº‹å‰ã«èª­ã¿è¾¼ã¿
        const compassImg = new Image();
        compassImg.src = 'N.png';
        compassImg.onload = function() {
            // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å†æç”»
            drawFarm();
        };
        
        // åˆæœŸæç”»
        drawFarm();
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹
        let isEditMode = false;
        
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateButtonStates() {
            const editBtn = document.getElementById('editBtn');
            const applyBtn = document.getElementById('applyBtn');
            const clearBtn = document.getElementById('clearBtn');
            
            if (isEditMode) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­
                editBtn.disabled = true;
                editBtn.style.backgroundColor = '#c8e6c9'; // è–„ã„ã‚°ãƒ¬ãƒ¼ç·‘
                applyBtn.disabled = false;
                applyBtn.style.backgroundColor = '#66bb6a'; // é€šå¸¸ã®ç·‘
                clearBtn.disabled = false;
                clearBtn.style.backgroundColor = '#a5d6a7'; // é€šå¸¸ã®è–„ç·‘
            } else {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å¤–
                editBtn.disabled = false;
                editBtn.style.backgroundColor = '#81c784'; // é€šå¸¸ã®ç·‘
                applyBtn.disabled = true;
                applyBtn.style.backgroundColor = '#e0e0e0'; // ã‚°ãƒ¬ãƒ¼
                clearBtn.disabled = true;
                clearBtn.style.backgroundColor = '#e0e0e0'; // ã‚°ãƒ¬ãƒ¼
            }
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        function enableEditMode() {
            if (isEditMode) return; // æ—¢ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            
            isEditMode = true;
            const selects = document.querySelectorAll('#detailSettings select');
            const inputs = document.querySelectorAll('#detailSettings input[type="text"]');
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
            selects.forEach(select => select.disabled = false);
            inputs.forEach(input => input.disabled = false);
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            updateButtonStates();
            
            console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹');
        }
        
        // è¨­å®šã‚’åæ˜ 
        function applySettings() {
            if (!isEditMode) {
                console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // è¨­å®šå€¤ã‚’ä¿å­˜ï¼ˆå®Ÿéš›ã®å‡¦ç†ã¯ã“ã“ã«å®Ÿè£…ï¼‰
            console.log('è¨­å®šã‚’åæ˜ ã—ã¾ã—ãŸ');
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
            exitEditMode();
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
        function exitEditMode() {
            isEditMode = false;
            const selects = document.querySelectorAll('#detailSettings select');
            const inputs = document.querySelectorAll('#detailSettings input[type="text"]');
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
            selects.forEach(select => select.disabled = true);
            inputs.forEach(input => input.disabled = true);
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            updateButtonStates();
            
            console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†');
        }
        
        // ã‚¯ãƒªã‚¢æ©Ÿèƒ½ï¼ˆã‚¯ã‚¤ãƒƒã‚¯è¨­å®šã®å€¤ã«æˆ»ã™ï¼‰
        function clearToPreset() {
            if (!isEditMode) {
                console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            console.log('ã‚¯ã‚¤ãƒƒã‚¯è¨­å®šã®å€¤ã«ãƒªã‚»ãƒƒãƒˆ');
            // ç¾åœ¨ã®ãƒ—ãƒªã‚»ãƒƒãƒˆå€¤ã‚’é©ç”¨
            applyPreset();
        }
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨
        window.addEventListener('DOMContentLoaded', function() {
            applyPreset();
            // åˆæœŸãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’è¨­å®š
            updateButtonStates();
        });
    </script>
</body>
</html>